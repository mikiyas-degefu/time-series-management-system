{% load static %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DPMEs</title>
    <link />
    <script src="https://mozilla.github.io/pdf.js/build/pdf.js"></script>

    {% include 'user-admin/common/head.html' %}
  </head>

  <body class="hold-transition sidebar-mini layout-fixed">
    {% include 'user-admin/common/navbar.html'%}
    <div>{% include 'user-admin/common/sidebar.html' %}</div>

    <!--Body Start-->
    <div class="content-wrapper">
      <div class="col-lg-7 mx-auto d-block">
        {% include 'includes/messages.html' %}
      </div>

      <!-- TItle Start-->
      <div class="content-header">
        <h4 class="text-info m-3">Documents</h4>
        <div class="container-fluid">
          <div class="table-responsive bg-white p-3">
            <div class="row p-3">
              <div class="col flot-right">
                <button
                  class="btn btn-primary float-end m-2"
                  data-bs-toggle="modal"
                  data-bs-target="#AddDocument"
                  data-bs-whatever="@mdo"
                >
                  <i class="fas fa-plus"></i> Add Document
                </button>
              </div>
            </div>
            <div class="container mt-4">
              {% if topics %}
                <!-- Dropdown Filter -->
                <div class="mb-4">
                  <label for="topicFilter" class="form-label fw-bold">Filter by Topic:</label>
                  <select class="form-select" id="topicFilter">
                    <option value="all">All Topics</option>
                    {% for topic in topics %}
                      {% if topic.get_document_lists %}
                        <option value="topic-{{ topic.id }}">{{ topic.title_ENG }}</option>
                      {% endif %}
                    {% endfor %}
                  </select>
                </div>

                <!-- All documents in one list -->
                <div class="row row-cols-1 row-cols-md-4 g-4" id="documentList">
                  {% for topic in topics %}
                    {% for document in topic.get_document_lists %}
                        <div class="col document-item" data-topic="topic-{{ topic.id }}">
                          <div class="card h-100">
                            <!-- Canvas with data attribute for the PDF URL -->
                            <canvas
                              id="pdf-canvas-{{ forloop.parentloop.counter }}-{{ forloop.counter }}"
                              data-pdf-url="{{ document.file.url }}"
                              style="height: 200px; width: 100%; border: 1px solid #ccc;"
                            ></canvas>

                            <div class="card-body">
                              <h6 class="card-title">{{ document.title_ENG }}</h6>
                              <p class="card-text">{{ document.title_AMH }}</p>
                              <hr />
                              <div class="d-flex justify-content-between align-items-center">
                                <a href="{{ document.file.url }}" target="_blank" class="btn btn-outline-success" title="View">
                                  <i class="fa fa-eye"></i>
                                </a>
                                <a href="{{ document.file.url }}" download class="btn btn-outline-success" title="Download">
                                  <i class="fa fa-download"></i>
                                </a>
                                <a href="{% url 'document_edit' document.id %}" class="btn btn-outline-info" title="Edit">
                                  <i class="fa fa-edit"></i>
                                </a>
                                <button
                                  class="btn btn-outline-danger btn-delete"
                                  data-bs-toggle="modal"
                                  data-bs-target="#deleteDocumentModal"
                                  data-id="{{ document.id }}"
                                  data-name="{{ document.title_ENG }}"
                                  title="Delete"
                                >
                                  <i class="fa fa-trash"></i>
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                    {% endfor %}
                  {% endfor %}
                </div>
              {% endif %}
            </div>

          </div>
        </div>
      </div>
      <!--Title End-->
    </div>
    <!--Body End-->

    <!--add document modal-->
    <div
      class="modal fade"
      id="AddDocument"
      tabindex="-1"
      aria-labelledby="AddDocumentLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="AddDocumentLabel">Documents</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="modal-body">{{form.as_p}}</div>

            <div class="modal-footer">
              <button
                type="button"
                class="btn btn-secondary"
                data-bs-dismiss="modal"
              >
                Close
              </button>
              <button type="submit" class="btn btn-primary">Yes</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!--delete documents modal-->
    <!--Delete  Modal-->
    <!-- Modal -->
    <div
      class="modal fade"
      id="deleteDocumentModal"
      tabindex="-1"
      aria-labelledby="deleteDocumentModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteDocumentModalLabel">
              Delete Topic
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <p class="h4 fw-normal" id="deleteTopic"></p>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Close
            </button>
            <a
              href="#"
              id="deleteTopicAnchor"
              type="submit"
              class="btn btn-danger"
              >Delete</a
            >
          </div>
        </div>
      </div>
    </div>
    <!--End Modal -->

    {% include 'user-admin/common/footer.html'%}

    <!--Chart -->
    <script src="{% static 'assets/plugins/jquery-ui/jquery-ui.min.js' %}"></script>
    <script src="{% static 'assets/plugins/chart.js/Chart.min.js' %}"></script>
    <script src="{% static 'assets/plugins/jquery-knob/jquery.knob.min.js' %}"></script>
    <script src="{% static 'assets/plugins/moment/moment.min.js' %}"></script>
    <script src="{% static 'assets/plugins/daterangepicker/daterangepicker.js' %}"></script>
    <script src="{% static 'assets/plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js' %}"></script>
    <script src="{% static 'assets/plugins/summernote/summernote-bs4.min.js' %}"></script>
    <script src="{% static 'assets/plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js' %}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>


    {% include 'user-admin/common/footer_js.html'%}

    <script>
      //Event handler that handle on Click to delete
      $(".btn-delete").on("click", function () {
        const buttonData = $(this).data();
        $("#deleteTopicAnchor").attr(
          "href",
          `/user-admin/document_delete/${buttonData.id}`
        );
        $("#deleteTopic").html(
          `Are you sure you want to delete <div> <code> ${buttonData.name}</code>? </div> `
        );
      });
    </script>
    <script>
       document.getElementById('topicFilter').addEventListener('change', function () {
        const selectedTopic = this.value;
        const items = document.querySelectorAll('.document-item');

        items.forEach(item => {
          const matches = selectedTopic === 'all' || item.dataset.topic === selectedTopic;
          item.style.display = matches ? 'block' : 'none';
        });
      });
      document.addEventListener("DOMContentLoaded", () => {
        const canvases = document.querySelectorAll('canvas[data-pdf-url]');
        canvases.forEach(canvas => {
          const url = canvas.dataset.pdfUrl;
          const loadingTask = pdfjsLib.getDocument(url);
          loadingTask.promise.then(pdf => {
            pdf.getPage(1).then(page => {
              const scale = 0.5;
              const viewport = page.getViewport({ scale: scale });
              const context = canvas.getContext('2d');
              canvas.height = viewport.height;
              canvas.width = viewport.width;
              page.render({
                canvasContext: context,
                viewport: viewport,
              });
            });
          }).catch(err => {
            console.error('Error loading PDF', err);
            canvas.style.display = 'none';
          });
        });
      });
    </script>
    
  </body>
</html>
